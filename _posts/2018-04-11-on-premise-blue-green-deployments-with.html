---
layout: post
title: On-premise Blue-Green deployments with TFS 2018 Update 2
date: '2018-04-11T17:13:00.003+01:00'
author: Matteo Emili
tags: 
modified_time: '2018-04-11T17:13:59.875+01:00'
thumbnail: https://1.bp.blogspot.com/-zAP3wvvMRjo/Ws4z3MJZ5PI/AAAAAAAAE5E/-xSUAVMotDUmA6yDoJ0EPjHN_XG3kY9aACLcBGAs/s72-c/bg.png
blogger_id: tag:blogger.com,1999:blog-9050180307874313601.post-1498114555904338925
blogger_orig_url: https://mattvsts.blogspot.com/2018/04/on-premise-blue-green-deployments-with.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><br /><div class="MsoNormal">Like I said in the previous post, modern deployment patterns are not an exclusive of the OTT providers and they are not something that requires using cloud technologies.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">After <a href="https://mattvsts.blogspot.co.uk/2018/04/on-premise-rolling-deployments-with-tfs.html">Rolling Deployments</a>, another very common pattern you might want to tackle is Blue-Green deployments. In a nutshell, it means having two identical environments to use in order to deploy new versions of your application with minimal downtime. <o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">It is a bit harder compared to a Rolling Deployment â€“ mainly because there could be countless variations on the technical details, depending on how your environment is composed, but letâ€™s try to jot down a skeleton version of a Blue-Green pipeline you can use.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">So in my case, I am using the same application I used in the previous post, with an additional environment (which happen to be a cluster, just to keep things a little more realistic). This is what my pipeline looks like:<o:p></o:p></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-zAP3wvvMRjo/Ws4z3MJZ5PI/AAAAAAAAE5E/-xSUAVMotDUmA6yDoJ0EPjHN_XG3kY9aACLcBGAs/s1600/bg.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="340" data-original-width="952" height="142" src="https://1.bp.blogspot.com/-zAP3wvvMRjo/Ws4z3MJZ5PI/AAAAAAAAE5E/-xSUAVMotDUmA6yDoJ0EPjHN_XG3kY9aACLcBGAs/s400/bg.png" width="400" /></a></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><span style="mso-no-proof: yes;"><!--[if gte vml 1]><v:shapetype  id="_x0000_t75" coordsize="21600,21600" o:spt="75" o:preferrelative="t"  path="m@4@5l@4@11@9@11@9@5xe" filled="f" stroked="f"> <v:stroke joinstyle="miter"/> <v:formulas>  <v:f eqn="if lineDrawn pixelLineWidth 0"/>  <v:f eqn="sum @0 1 0"/>  <v:f eqn="sum 0 0 @1"/>  <v:f eqn="prod @2 1 2"/>  <v:f eqn="prod @3 21600 pixelWidth"/>  <v:f eqn="prod @3 21600 pixelHeight"/>  <v:f eqn="sum @0 0 1"/>  <v:f eqn="prod @6 1 2"/>  <v:f eqn="prod @7 21600 pixelWidth"/>  <v:f eqn="sum @8 21600 0"/>  <v:f eqn="prod @7 21600 pixelHeight"/>  <v:f eqn="sum @10 21600 0"/> </v:formulas> <v:path o:extrusionok="f" gradientshapeok="t" o:connecttype="rect"/> <o:lock v:ext="edit" aspectratio="t"/></v:shapetype><v:shape id="Picture_x0020_1" o:spid="_x0000_i1026" type="#_x0000_t75"  style='width:451.5pt;height:161.25pt;visibility:visible;mso-wrap-style:square'> <v:imagedata src="file:///C:/Users/MATTEO~1.ACM/AppData/Local/Temp/msohtmlclip1/01/clip_image001.png"   o:title=""/></v:shape><![endif]--><!--[if !vml]--><!--[endif]--></span><o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal">Each environments follows the following process:<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><span style="mso-no-proof: yes;"><!--[if gte vml 1]><v:shape  id="Picture_x0020_2" o:spid="_x0000_i1025" type="#_x0000_t75" style='width:450.75pt;  height:589.5pt;visibility:visible;mso-wrap-style:square'> <v:imagedata src="file:///C:/Users/MATTEO~1.ACM/AppData/Local/Temp/msohtmlclip1/01/clip_image003.png"   o:title=""/></v:shape><![endif]--><!--[if !vml]--><!--[endif]--></span><o:p></o:p></div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-c01omk32Jpw/Ws4z3M12XxI/AAAAAAAAE5I/-4yH3_ceHBAQ7hxWsUsu7SSyR3H802tDwCLcBGAs/s1600/bg1.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="804" data-original-width="615" height="640" src="https://2.bp.blogspot.com/-c01omk32Jpw/Ws4z3M12XxI/AAAAAAAAE5I/-4yH3_ceHBAQ7hxWsUsu7SSyR3H802tDwCLcBGAs/s640/bg1.png" width="488" /></a></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal"><br /></div><div class="MsoNormal">Letâ€™s say we are running all of this against the blue cluster, which is currently production. <o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">The first phase is an Agent Phase â€“ it swaps production traffic from the blue cluster to the green one.&nbsp;</div><div class="MsoNormal"><br /></div><div class="MsoNormal">I want it to be independent from the environments so that it can deal with the router that manages traffic between the two clusters. As I do not have an appliance or anything special in front of them (I am just playing with CNAME records in my lab domain) this ensures the process is not tied to any machine.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">Moreover, this pipeline is designed to be used just after everything is deemed production-ready, so if it fails it is not meant to be ran again without a hitch.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">The reason behind this choice is that I wanted to share a general idea of how to do this on-premise, and there might be so many permutations of what you might need to do or what could go wrong that my example with all the possible fail safes in place would have been way too complex.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">Up next, the Rolling Deployment we saw in the last post for both nodes of the blue cluster, one at a time.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">Then, even if you are running this for a production application you still need to make sure your smoke tests are passing. This is literally the last line of defense before the switch.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">Eventually, a warm-up script to ensure that my application is responding correctly when it is going to be used from my users. <o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">Now the magic happens: as soon as you move to the second Environment, traffic is switched to the blue cluster again (which is done with the v2, and warm enough for production traffic) in a seamless way while the whole process goes on against the green cluster.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">Of course, there are some things to consider. The first one, is that this pipeline is not designed to be a commit-to-production pipeline: there is no backup mechanism in it and no revert process if one environment fails (this lives with the fact that you should already have the pipelines defined in the previous post though <span style="font-family: &quot;Segoe UI Emoji&quot;,sans-serif; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-char-type: symbol-ext; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-symbol-font-family: &quot;Segoe UI Emoji&quot;;">ðŸ˜Š</span>). <o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">You want to use approvals to manage the switch from green to blue, so that only when it is checked then you can go ahead.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">Eventually (this is quite important though), your application must be able to cope with environment change â€“ it should be message-based, or stateless. Traditional stateful applications can have problems with it, which can be mitigated with message queues for example, so we are back to square one <span style="font-family: &quot;Segoe UI Emoji&quot;,sans-serif; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-char-type: symbol-ext; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-symbol-font-family: &quot;Segoe UI Emoji&quot;;">ðŸ˜Š</span><o:p></o:p></div><br /></div>