---
layout: post
title: Marking transactions on Team Foundation Server’s databases
date: '2012-10-22T20:50:00.001+01:00'
author: Matteo Emili
tags: 
modified_time: '2012-10-22T20:50:40.104+01:00'
blogger_id: tag:blogger.com,1999:blog-9050180307874313601.post-9023098421302531159
blogger_orig_url: https://mattvsts.blogspot.com/2012/10/marking-transactions-on-team-foundation.html
---

<p>As we know, in the Team Foundation Server PowerTools for the 2010 version and built-in in the 2012 version we have a Backup&amp;Restore utility which is added to the Administration console for…backup purposes J  <p>But it’s not always feasible: in some organization this kind of tooling could not be allowed, and therefore we have to follow the old manual procedure documented in MSDN.  <p>It’s a little bit tedious, as it’s fully manual and we have to repeat this for each database in our Team Foundation Server deployment, so it can be error-prone, and during troubleshooting sessions it can lead to issues.  <p>So, in order to minimize this, there’s a useful step to follow to track down all the transactions on the TFS’ databases: the transaction table.  <p>It’s fairly easy: we have to create an empty table in each database, using the following script: <br> <div class="csharpcode"><pre><span class="lnum">   1:  </span><span class="kwrd">Use</span> TFS_Configuration </pre><pre><span class="lnum">   2:  </span><span class="kwrd">Create</span> <span class="kwrd">Table</span> Tbl_TransactionLogMark </pre><pre><span class="lnum">   3:  </span>( </pre><pre><span class="lnum">   4:  </span> logmark <span class="kwrd">int</span> </pre><pre><span class="lnum">   5:  </span>) </pre><pre><span class="lnum">   6:  </span><span class="kwrd">GO</span> </pre><pre><span class="lnum">   7:  </span>Insert <span class="kwrd">into</span> Tbl_TransactionLogMark (logmark) <span class="kwrd">Values</span> (1) </pre><pre><span class="lnum">   8:  </span><span class="kwrd">GO</span> </pre></div><br /><style type="text/css">.csharpcode, .csharpcode pre<br />{<br />	font-size: small;<br />	color: black;<br />	font-family: consolas, "Courier New", courier, monospace;<br />	background-color: #ffffff;<br />	/*white-space: pre;*/<br />}<br />.csharpcode pre { margin: 0em; }<br />.csharpcode .rem { color: #008000; }<br />.csharpcode .kwrd { color: #0000ff; }<br />.csharpcode .str { color: #006080; }<br />.csharpcode .op { color: #0000c0; }<br />.csharpcode .preproc { color: #cc6633; }<br />.csharpcode .asp { background-color: #ffff00; }<br />.csharpcode .html { color: #800000; }<br />.csharpcode .attr { color: #ff0000; }<br />.csharpcode .alt <br />{<br />	background-color: #f4f4f4;<br />	width: 100%;<br />	margin: 0em;<br />}<br />.csharpcode .lnum { color: #606060; }<br /></style><br /><br /><p>After that, we can create a Stored Procedure which marks every transaction on the TFS’ databases, and reports back to the table: <br><br /><div class="csharpcode"><pre><span class="lnum">   1:  </span><span class="kwrd">Create</span> <span class="kwrd">PROCEDURE</span> sp_SetTransactionLogMark </pre><pre><span class="lnum">   2:  </span>@name nvarchar (128) </pre><pre><span class="lnum">   3:  </span><span class="kwrd">AS</span> </pre><pre><span class="lnum">   4:  </span><span class="kwrd">BEGIN</span> <span class="kwrd">TRANSACTION</span> @name <span class="kwrd">WITH</span> MARK </pre><pre><span class="lnum">   5:  </span><span class="kwrd">UPDATE</span> TFS_Configuration.dbo.Tbl_TransactionLogMark <span class="kwrd">SET</span> logmark = 1 </pre><pre><span class="lnum">   6:  </span><span class="kwrd">COMMIT</span> <span class="kwrd">TRANSACTION</span> </pre><pre><span class="lnum">   7:  </span><span class="kwrd">GO</span> </pre></div><br /><style type="text/css">.csharpcode, .csharpcode pre<br />{<br />	font-size: small;<br />	color: black;<br />	font-family: consolas, "Courier New", courier, monospace;<br />	background-color: #ffffff;<br />	/*white-space: pre;*/<br />}<br />.csharpcode pre { margin: 0em; }<br />.csharpcode .rem { color: #008000; }<br />.csharpcode .kwrd { color: #0000ff; }<br />.csharpcode .str { color: #006080; }<br />.csharpcode .op { color: #0000c0; }<br />.csharpcode .preproc { color: #cc6633; }<br />.csharpcode .asp { background-color: #ffff00; }<br />.csharpcode .html { color: #800000; }<br />.csharpcode .attr { color: #ff0000; }<br />.csharpcode .alt <br />{<br />	background-color: #f4f4f4;<br />	width: 100%;<br />	margin: 0em;<br />}<br />.csharpcode .lnum { color: #606060; }<br /></style><br /><br /><p>Then you can run the Stored Procedure, and mark the transactions with a mark. As MSDN states, “TFSMark”.<br><br /><div class="csharpcode"><pre><span class="lnum">   1:  </span><span class="kwrd">EXEC</span> sp_SetTransactionLogMarkAll <span class="str">'TFSMark'</span></pre><pre><span class="lnum">   2:  </span><span class="kwrd">GO</span></pre></div><br /><style type="text/css">.csharpcode, .csharpcode pre<br />{<br />	font-size: small;<br />	color: black;<br />	font-family: consolas, "Courier New", courier, monospace;<br />	background-color: #ffffff;<br />	/*white-space: pre;*/<br />}<br />.csharpcode pre { margin: 0em; }<br />.csharpcode .rem { color: #008000; }<br />.csharpcode .kwrd { color: #0000ff; }<br />.csharpcode .str { color: #006080; }<br />.csharpcode .op { color: #0000c0; }<br />.csharpcode .preproc { color: #cc6633; }<br />.csharpcode .asp { background-color: #ffff00; }<br />.csharpcode .html { color: #800000; }<br />.csharpcode .attr { color: #ff0000; }<br />.csharpcode .alt <br />{<br />	background-color: #f4f4f4;<br />	width: 100%;<br />	margin: 0em;<br />}<br />.csharpcode .lnum { color: #606060; }<br /></style><br /><br /><p>So you can automate this Stored Procedure, and use it as a ‘filtered log’ on your database activities. <br /><p>It’s nothing new in the end, but as it’s hidden inside the MSDN documentation I’ve never seen it out there, and IMHO it was worth of a mention. </p>  