---
layout: post
title: Useful SQL queries for the TFS Administrator
date: '2015-01-08T11:37:00.001Z'
author: Matteo Emili
tags: 
modified_time: '2015-01-08T11:37:39.227Z'
thumbnail: http://lh4.ggpht.com/-O48KSZSv7wU/VK5r-hoD_0I/AAAAAAAABuQ/1XZISypxYhE/s72-c/image_thumb%25255B1%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-9050180307874313601.post-6690116420083641706
blogger_orig_url: https://mattvsts.blogspot.com/2015/01/useful-sql-queries-for-tfs-administrator.html
---

<p>Right, right – <strong>I know</strong>:</p> <p><a href="http://lh5.ggpht.com/--TIoAXqege8/VK5r-PYe_YI/AAAAAAAABuI/X9LEiegvmjU/s1600-h/image%25255B3%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://lh4.ggpht.com/-O48KSZSv7wU/VK5r-hoD_0I/AAAAAAAABuQ/1XZISypxYhE/image_thumb%25255B1%25255D.png?imgmax=800" width="644" height="81"></a> </p> <p><a href="http://lh6.ggpht.com/-7ihFM6I0LLM/VK5r_J5bfgI/AAAAAAAABuU/T1RG-IKPgRE/s1600-h/image%25255B7%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://lh4.ggpht.com/-kMcVuHdqLPM/VK5r_hwvDNI/AAAAAAAABuc/YLOcDXLxfJw/image_thumb%25255B3%25255D.png?imgmax=800" width="644" height="157"></a> </p> <p>I would actually replace <em>can</em> with <em>will</em>, but people might think I am too harsh. Remember – the TFS databases cannot be modified by nobody but Microsoft, otherwise you won’t get support, you might experience unknown (and untested!) issues and mostly important – you would lose any upgrade path as the schemas are checked by the TFS installer.</p> <p>Anyway I won’t be talking about modifying the databases, while instead I wanted to share some useful queries I found during my almost ten years experience with Team Foundation Server.</p> <p>SQL Server is a <a href="http://en.wikipedia.org/wiki/Deterministic_system">deterministic system</a>, but sometimes <em>it doesn’t seem to be</em>. For instance, AlwaysOn is synchronising some data after you messed up with a Team Project Collection used for testing purposes, and despite it might look stuck it is actually doing <em>something</em>.</p> <p>The AlwaysOn Dashboard doesn’t show anything but a <strong>Synchronizing</strong> status, so how can I say so?</p> <p>Run this query:</p> <p></p> <p></p> <p>SELECT dmv_2.login_name AS Invoker, <br>dmv_1.session_id AS SPID, <br>command as 'Instruction Type',<br>a.text AS Query, <br>start_time AS 'Initiated at', <br>percent_complete AS Percentage, <br>dateadd(second,estimated_completion_time/1000, getdate()) AS ETA <br>FROM sys.dm_exec_requests dmv_1 <br>CROSS APPLY sys.dm_exec_sql_text(dmv_1.sql_handle) a <br>INNER JOIN sys.dm_exec_sessions dmv_2 <br>ON dmv_1.session_id = dmv_2.session_id <p>This is what you’ll get: <p><a href="http://lh5.ggpht.com/-yTLTFLn2GK8/VK5sAMU2XBI/AAAAAAAABuk/MxgYaUtSTNs/s1600-h/image%25255B13%25255D.png"><img title="image" style="border-top: 0px; border-right: 0px; border-bottom: 0px; border-left: 0px; display: inline" border="0" alt="image" src="http://lh4.ggpht.com/-WKfRXuCaOC4/VK5sAZeIjuI/AAAAAAAABus/qxgwag-Njjg/image_thumb%25255B7%25255D.png?imgmax=800" width="644" height="86"></a>  <p>Excluding the line where I am the Invoker – of course – I can see all the activity at 11:08am: <ul> <li>NT AUTHORITY\SYSTEM running <strong>sp_server_diagnostics</strong></li> <li>The TFS and SQL service account in this testing environment running an <strong>INSERT query</strong> – that is AlwaysOn!</li></ul> <p>That query leverages <a href="http://msdn.microsoft.com/en-us/library/ms188754.aspx">SQL Server’s DMVs</a>, and it is very handy for checking all the things happening in the Database Engine.</p> <p>Another one is about Transaction Log files – what about their physical status?</p> <p>SELECT Name, <br>database_id, <br>log_reuse_wait,<br>log_reuse_wait_desc <br>FROM sys.databases <p>Querying sys.databases can give you the status of your Transaction Log files. I needed that because I was running some <em>extreme</em> tests in borderline conditions, hence I had to monitor their status. <a href="http://msdn.microsoft.com/en-us/library/ms178534.aspx">Sys.databases</a> is very handy for other information as well.</p> <p>Eventually, as Grant <a href="http://blogs.msdn.com/b/granth/archive/2013/10/08/what-does-a-well-maintained-team-foundation-server-look-like.aspx">suggests</a> (and he is always right!), <strong>DBCC CHECKDB </strong>regularly is a must. And please, have a test server around so you can compare all the behaviours, if any.</p>  