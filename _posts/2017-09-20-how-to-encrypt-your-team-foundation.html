---
layout: post
title: How to encrypt your Team Foundation Server data tier
date: '2017-09-20T12:26:00.001+01:00'
author: Matteo Emili
tags: 
modified_time: '2017-09-20T12:26:02.696+01:00'
thumbnail: https://lh3.googleusercontent.com/-G6GkCbCxQXQ/WcJQSU_1D3I/AAAAAAAAEks/t3o5Ee-5Rdo9qetz8wgqlMSw-SgU_OdFwCHMYCw/s72-c/wlEmoticon-smile%255B2%255D?imgmax=800
blogger_id: tag:blogger.com,1999:blog-9050180307874313601.post-3395088915267884931
blogger_orig_url: https://mattvsts.blogspot.com/2017/09/how-to-encrypt-your-team-foundation.html
---

<p>For all sorts of reasons (including GDPR looming on you) you might feel the need to encrypt your Team Foundation Server databases. Proper encryption at rest.</p><p>I realised this is not a really well documented scenario, but it is surprisingly easy to achieve.</p><p>What you need to do is leverage SQL Server TDE (Transparent Data Encryption), which is out-of-the-box since SQL Server 2008 onwards. It acts at page level and it is transparent, with little overhead.</p><p>The process of enabling TDE is very <a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/transparent-data-encryption">well documented</a>, and it is based off two keys (the <strong>master key</strong> and the <strong>encryption key</strong>) and a certificate. It is very straightforward if you have a single server as a data tier, off you go.</p><p>Now, this gets slightly more <em>complicated</em> if you have (like me <img class="wlEmoticon wlEmoticon-smile" style="" alt="Smile" src="https://lh3.googleusercontent.com/-G6GkCbCxQXQ/WcJQSU_1D3I/AAAAAAAAEks/t3o5Ee-5Rdo9qetz8wgqlMSw-SgU_OdFwCHMYCw/wlEmoticon-smile%255B2%255D?imgmax=800">) AlwaysOn protecting your High Availability. Well, <em>complicated </em>if it is the first time you approach the topic.</p><p>Working with AlwaysOn requires:</p><ul><li>On the <strong>Primary Replica</strong> - creating the master key, the certificate and the encryption key. Remember to backup the master key and the certificate.</li><li>On the <strong>Secondary Replica</strong> - creating the master key and the certificate. The certificate must be created from the backup of the Primary Replica!</li></ul><p>After these two steps you can enable TDE on the database hosted on the Primary Replica, which then will propagate on the Secondary as per AlwaysOn schedule.</p><p>If your databases are already encrypted and you want to add them to an Availability Group you’ll need to do so manually – the wizard is not going to show encrypted databases to be added to the AG. </p><p><a href="http://www.sqlservercentral.com/articles/always+on/135432/">This</a> SQLServerCentral.com article features a set of queries I found really helpful to get started. </p><p>A suggestion though: prepare a single query for the Primary Replica preparation, run it, prepare a single one for the Secondary Replica preparation, run it, and eventually encrypt from a separate query. </p><p>The reason why I say this is simple: if anything goes wrong before you encrypt the database you can easily drop the master key, the certificate or the encryption key and start again.</p><p>Eventually, remember that encryption for large databases can take a long time. During this time, the process might stop because of database size, so remember to <a href="https://blogs.msdn.microsoft.com/samlester/2015/06/23/transparent-data-encryption-tde-stuck-in-state-2-encryption-in-progress/">check the logs</a> as well so you can restart it if you need to.</p>