---
layout: post
title: A collection of SQL Server-related tips for the TFS Administrator
date: '2018-08-20T20:56:00.000+01:00'
author: Matteo Emili
tags: 
modified_time: '2018-08-20T20:56:58.583+01:00'
blogger_id: tag:blogger.com,1999:blog-9050180307874313601.post-6294187501328232575
blogger_orig_url: https://mattvsts.blogspot.com/2018/08/a-collection-of-sql-server-related-tips.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><br /><div class="MsoNormal">If you run Team Foundation Server on-premise, understanding how SQL Server works on the Data Tier is extremely important. Despite the push for the cloud, there might be so many reasons why you need to stick with your on-premise installation of TFS ‚Äì and the bigger the instance is the more SQL Server knowledge you will eventually need.<o:p></o:p></div><div class="MsoNormal"><br /></div><div class="MsoNormal">I am not a SQL Server expert myself, but between my past as a consultant and now being in a position where I administer a huge TFS instance meant that sooner or later I had to deal with SQL Server on a one-to-one basis. Not always the happiest of encounters to be fair <span style="font-family: &quot;Segoe UI Emoji&quot;,sans-serif; mso-ascii-font-family: Calibri; mso-ascii-theme-font: minor-latin; mso-char-type: symbol-ext; mso-hansi-font-family: Calibri; mso-hansi-theme-font: minor-latin; mso-symbol-font-family: &quot;Segoe UI Emoji&quot;;">üòä</span> but still, I learned a lot. So I thought that if you are in my position ‚Äì where you might be <i style="mso-bidi-font-style: normal;">the</i> TFS Administrator ‚Äì then hopefully a collection of notes I took over time might be handy for you.<o:p></o:p></div><div class="MsoNormal"><br /></div><h2 style="text-align: left;">SQL Server always wins ‚Äì be prepared for it ‚Äì and never, ever touch the databases</h2><h2><o:p></o:p></h2><div class="MsoNormal">It‚Äôs not really a tip, but something to keep in mind: given that Team Foundation Server is essentially a product where you have web services in front of a set of databases, hence if the databases have problems the whole product is down. Remember that ‚Äì when something goes (very) wrong, keep in mind the Data Tier, sometimes it is silly stuff like the drive where the master database resides being full‚Ä¶<o:p></o:p></div><div class="MsoNormal">Also, never, ever touch the databases manually unless instructed by the Microsoft Support Team. Don‚Äôt be tempted to <i style="mso-bidi-font-style: normal;">optimise </i>the databases, the number of things that can go wrong is simply too high to risk being in a corrupted state or unsupported situation. Don‚Äôt do that.<o:p></o:p></div><div class="MsoNormal"><br /></div><h2 style="text-align: left;">Use the TFS Administration Console built-in backup tool if you can</h2><h2><o:p></o:p></h2><div class="MsoNormal">The temptation of letting <i style="mso-bidi-font-style: normal;">someone else</i> (the IT department, a DBA, etc.) deal with the menial task of backing up your Data Tier can be very high, but if you can just use the built-in backup tool. It makes it transparent to you and takes away the hassle of creating maintenance plans.<o:p></o:p></div><div class="MsoNormal">If you have databases in Full Recovery Mode, it will take care of your Transaction Logs backup in an atomic manner ‚Äì it is very important. If you take backups at different times for example, you might end up in a situation where you have identities in a Collection database which does not correlate with the Configuration database. To avoid this, you should <span class="MsoHyperlink"><a href="https://docs.microsoft.com/en-gb/tfs/server/admin/backup/manually-backup-tfs?view=vsts">mark your transactions</a></span> as part of your backup plan.<o:p></o:p></div><div class="MsoNormal">Also don‚Äôt forget to backup your SSRS Encryption Key, otherwise you might be restoring a useless set of databases in a Disaster Recovery scenario!<o:p></o:p></div><div class="MsoNormal"><br /></div><h2 style="text-align: left;">High Availability means AlwaysOn!</h2><h2><o:p></o:p></h2><div class="MsoNormal">To be fair it is not really the case, but it makes your life so much simpler. AlwaysOn makes Highly Available deployments a breeze, and even if you have to factor in <span class="MsoHyperlink"><a href="https://mattvsts.blogspot.com/2014/08/tfs-transaction-marking-on-sql-server.html">some adjustments</a></span> to your habits it is worth it every single time.<o:p></o:p></div><div class="MsoNormal">Beware though: even if you implement AlwaysOn for your Database Engine, you will not get Analysis Services for free on the same setup ‚Äì that is a different deployment altogether.<o:p></o:p></div><div class="MsoNormal"><br /></div><h2 style="text-align: left;">Keep an eye on your drives</h2><div class="MsoNormal">This is something I experienced fairly recently ‚Äì aside from the usual recommendation on where to put your databases (system or otherwise), if you have a very large database you could run into file system limitations that prevent DBCC CHECKDB from running and make you lose sleep. If you happen to experience these, it is worth knowing that not everything is lost and you might not even need to restore from a backup.<o:p></o:p></div><div class="MsoNormal">NTFS has a switch (/L) that is designed around large files, it is an excellent starting point although you need to format your drives. Another solution revolves around using ReFS instead of NTFS ‚Äì it is something somehow unknown, but after running it for a while in my homelab and using it to solve a portion of this problem I can say that ReFS is a powerful ‚Äútool‚Äù (I can‚Äôt really consider a file system a tool, but for lack of a better word‚Ä¶) to resort to in case you find the dreaded error 665 in your logs.<o:p></o:p></div><div class="MsoNormal"><br /></div><h2 style="text-align: left;">Remember to check what is going on</h2><div class="MsoNormal">I use this <span class="MsoHyperlink"><a href="https://mattvsts.blogspot.com/2015/01/useful-sql-queries-for-tfs-administrator.html">couple of queries</a></span> since‚Ä¶ I don‚Äôt know, ages. They help, because they show in a transparent way what is going on within a SQL Server instance (especially if you need to understand what AlwaysOn is doing) and they provide information that can help diagnosing certain errors.<o:p></o:p></div><div class="MsoNormal"><br /></div><br /></div>