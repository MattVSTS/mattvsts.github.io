---
layout: post
title: 'A set of tricky situations with HTTPS and TFS '
date: '2018-06-27T17:53:00.000+01:00'
author: Matteo Emili
tags: 
modified_time: '2018-06-27T17:53:11.299+01:00'
blogger_id: tag:blogger.com,1999:blog-9050180307874313601.post-7164736179417256716
blogger_orig_url: https://mattvsts.blogspot.com/2018/06/a-set-of-tricky-situations-with-https.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">HTTPS is more and more common-place, not just for public websites but also for internal websites. This is extremely good for a number of reasons, but from an administration standpoint there are a few bits to keep in mind.<br /><br />In particular, when it comes to Team Foundation Server this is a list of errors and problems that go away with a common denominator: the right certificate.<br /><br />The number one offender is of course the <i>out-of-domain machine</i>. If you have a domain-joined machines these problems simply do not happen because the internal certificate is deployed by the domain GPO - hence you don't have to fiddle with it. When your machine is not domain-joined, things can easily <i>go south</i>.<br /><br />Bear in mind - these are not <i>security</i>&nbsp;tips, this is just a collection of situations which you will face if you deploy HTTPS with TFS.<br /><br /><h2 style="text-align: left;">Non domain-joined machines</h2><div>If you are running a non domain-joined machine then you need to procure the root certificate for your domain and install it in the Trusted Root Certification Authorities store on your machine. This needs to be done on any machine not part of your domain, otherwise you won't be able to do pretty much anything.</div><h2 style="text-align: left;"><br />Build agents</h2><div>Build agents need to be reconfigured. You can't run away from this, if you don't do that they will be working until the authentication token expires, and then you will start seeing this error in the Event Log after they go offline:</div><div><br /></div><div><i>Agent connect error: The audience of the token is invalid.. Retrying every 30 seconds until reconnected</i></div><div><i><br /></i></div><div>You need to de-register (<i>config.cmd remove</i>) and re-register your build agents in any pool. Not too bad, but it needs to be planned for.</div><h2 style="text-align: left;"><br />The Deploy Test Agent task in Build and Release</h2>If you don't have your certificate installed on both the Agent (if outside the domain) and the target machine (again, if outside the domain) then you will get this cryptic error:<br /><br /><i>The running command stopped because the preference variable "ErrorActionPreference" or common parameter is set to Stop: Exception calling ".ctor" with "2" argument(s): "One or more errors occurred."</i><br /><div><br /></div><div>It's a communication issue between the target machine and TFS. Once the certificate is installed it goes away and the task works normally. This <a href="https://www.blogger.com/"><span id="goog_117591768"></span>GitHub issue<span id="goog_117591769"></span></a> also recommends enabling TLS v1.2, which is not a bad idea.</div><h2 style="text-align: left;"><br />&nbsp;Git</h2><div>Git holds a special spot in this collection, because of how it handles SSL. While newer versions of Git for Windows made this really straightforward (hint: they support the Windows Credential Manager), but if you aren't running the latest and greatest then this is what could happen with Git on your local machine, even if it is joined to the domain:</div><div><br /><i>C:\&gt;git clone https://myserver/Collection/_git/Project&nbsp;</i><br /><i>Cloning into 'Project'...&nbsp;</i><br /><i>fatal: unable to access 'https://myserver/Collection/_git/Project/': SSL certificate problem: unable to get local issuer certificate</i></div><div><div style="background-color: white; box-sizing: border-box; margin-bottom: 10px;"><div style="color: #333333; font-family: &quot;segoe ui&quot;, tahoma, arial, &quot;helvetica neue&quot;, helvetica, sans-serif; font-size: 14px;"><span style="box-sizing: border-box; font-family: &quot;courier new&quot;; font-size: xx-small;"><br /></span></div><div style="color: #333333; font-family: &quot;segoe ui&quot;, tahoma, arial, &quot;helvetica neue&quot;, helvetica, sans-serif; font-size: 14px;"><span style="box-sizing: border-box; font-family: &quot;courier new&quot;; font-size: xx-small;"></span></div><div style="-webkit-text-stroke-width: 0px; color: black; font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-decoration-color: initial; text-decoration-style: initial; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"></div><div style="color: #333333; font-family: &quot;segoe ui&quot;, tahoma, arial, &quot;helvetica neue&quot;, helvetica, sans-serif; font-size: 14px;"></div><div style="orphans: 2; text-align: left; text-decoration-color: initial; text-decoration-style: initial; text-indent: 0px; widows: 2;">You can sort this out in many ways, but the best one is Philip Kelley's approach. It just works, even if it is a bit of a walkthrough. This applies not only on the client, but also on the build agent if you are not running a recent version of the agent itself. It can be easily corrected by replacing the ca-bundle.crt file over there, it is not going to be replaced until you update the agent to a newer version.<br /><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: 400; letter-spacing: normal; margin: 0px; text-transform: none; white-space: normal; word-spacing: 0px;">Also, a false friend:</div><div style="-webkit-text-stroke-width: 0px; color: black; font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: 400; letter-spacing: normal; margin: 0px; text-transform: none; white-space: normal; word-spacing: 0px;"><br /></div><i>error: RPC failed; curl 56 OpenSSL SSL_read: SSL_ERROR_SYSCALL, errno 10054</i><br /><i>fatal: read error: Invalid argument, 255.05 MiB | 1.35 MiB/s</i><br /><i>fatal: early EOF</i><br /><i>fatal: index-pack failed</i><br /><div><br /></div>It can be all sorts of things, especially as the error points at OpenSSL - but check your connection's stability first before messing up with Git's postBuffer and compression ðŸ˜ƒ if the <i>git clone</i>&nbsp;operation starts the problem is not the SSL authentication.<br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: 400; letter-spacing: normal; text-transform: none; white-space: normal; word-spacing: 0px;"><br /></div></div></div></div></div>