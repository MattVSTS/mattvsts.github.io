---
layout: post
title: Move TFS databases with no downtime, thanks to SQL Server AlwaysOn
date: '2017-03-21T14:14:00.000Z'
author: Matteo Emili
tags: 
modified_time: '2017-03-21T14:14:27.377Z'
thumbnail: https://2.bp.blogspot.com/-ynIJXwmkaJs/WM7B0nSDLwI/AAAAAAAAEaI/mMU7yw4GqdcfRACPEIcLk0EN010hAf4bwCLcB/s72-c/0.PNG
blogger_id: tag:blogger.com,1999:blog-9050180307874313601.post-1810466925222006541
blogger_orig_url: https://mattvsts.blogspot.com/2017/03/move-tfs-databases-with-no-downtime.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">If you follow this blog or my Twitter feed you should know I am a massive fan of SQL Server AlwaysOn.<br /><br />Recently I restored and moved some TFS databases around, and one of them remained on a temporary storage because of the massive size involved. After a while I managed to sort out the primary storage so I could move this database (and its Transaction Log) back to it.<br /><br />This what I did, no warranties of course but <i>it worked on my machines!</i><br /><br />First of all, you need to be aware that you will have a limited availability during this period. It doesn't mean you are going to have an outage, but that you cannot rely on the Secondary Replica while you work on it. Why? Because you need to disable the Automatic Failover and make any Secondary non-readable:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-ynIJXwmkaJs/WM7B0nSDLwI/AAAAAAAAEaI/mMU7yw4GqdcfRACPEIcLk0EN010hAf4bwCLcB/s1600/0.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="81" src="https://2.bp.blogspot.com/-ynIJXwmkaJs/WM7B0nSDLwI/AAAAAAAAEaI/mMU7yw4GqdcfRACPEIcLk0EN010hAf4bwCLcB/s400/0.PNG" width="400" /></a></div><br /><br /><br /><br /><br /><br /><br />Then suspend Data Movement from the Primary. This means your Primary Replica is not going to sync with the Secondary.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-HrxNghvOTG8/WM7B0kaTTeI/AAAAAAAAEaA/2eLe2x1jPxo4h5zBR6uEWEWfJ6JBim8oQCLcB/s1600/1.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="https://3.bp.blogspot.com/-HrxNghvOTG8/WM7B0kaTTeI/AAAAAAAAEaA/2eLe2x1jPxo4h5zBR6uEWEWfJ6JBim8oQCLcB/s1600/1.PNG" /></a></div><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />You will get your database to move in a non synchronised state.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-a6eK1_gY6sE/WM7B0qeDZYI/AAAAAAAAEaE/mCJUSSlIO7Qd8eJ7CB-kIcEp40f39CvWQCLcB/s1600/2.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="https://2.bp.blogspot.com/-a6eK1_gY6sE/WM7B0qeDZYI/AAAAAAAAEaE/mCJUSSlIO7Qd8eJ7CB-kIcEp40f39CvWQCLcB/s1600/2.PNG" /></a></div><br /><br /><br /><br />Now note down your logical names for the files you need to move. Use these in the following query, the path in the FILENAME is going to be the new destination:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-AI33gnSQeQI/WM7B0wvf9qI/AAAAAAAAEaQ/YUTnwDU7HtkIHpzlmiHd_0LONHpO6ZnpACLcB/s1600/3.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="https://3.bp.blogspot.com/-AI33gnSQeQI/WM7B0wvf9qI/AAAAAAAAEaQ/YUTnwDU7HtkIHpzlmiHd_0LONHpO6ZnpACLcB/s1600/3.PNG" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-nuHzaJpoycM/WM7B0wlE-fI/AAAAAAAAEaM/I05gwyEvKCoaO1RP0GCxYUUw2WHmw97KACLcB/s1600/4.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="121" src="https://4.bp.blogspot.com/-nuHzaJpoycM/WM7B0wlE-fI/AAAAAAAAEaM/I05gwyEvKCoaO1RP0GCxYUUw2WHmw97KACLcB/s400/4.PNG" width="400" /></a></div><br /><br /><br /><br /><br /><br /><br /><br /><br />Run this on all servers. You might want to wait for the Secondary to be up-and-running, but don't forget to run it against the Primary too!<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-U5Hz7FbfKDk/WM7B0zxi5EI/AAAAAAAAEaU/n_NohgyL-OQ_KqoFLUMoX_Ckf9gI7rO-ACLcB/s1600/5.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="35" src="https://1.bp.blogspot.com/-U5Hz7FbfKDk/WM7B0zxi5EI/AAAAAAAAEaU/n_NohgyL-OQ_KqoFLUMoX_Ckf9gI7rO-ACLcB/s400/5.PNG" width="400" /></a></div><br /><br /><br /><br />Copy all the files to the new destination, once done restart SQL Server on the Secondary:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-tg1t54-LIwY/WM7B1IYDgRI/AAAAAAAAEaY/ENUpKs1v2RklMjaUyYJ3tfAuAqaOl58zgCLcB/s1600/6.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="https://1.bp.blogspot.com/-tg1t54-LIwY/WM7B1IYDgRI/AAAAAAAAEaY/ENUpKs1v2RklMjaUyYJ3tfAuAqaOl58zgCLcB/s1600/6.PNG" /></a></div><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />Now check that if Secondary is in a green state.<br /><br /><br /><a href="https://3.bp.blogspot.com/-11kPZWY4ZKs/WM7B1MsaMaI/AAAAAAAAEac/iSQBeeXXAk49t0hjnlZE9dFc3xvYnJo2QCLcB/s1600/7.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="https://3.bp.blogspot.com/-11kPZWY4ZKs/WM7B1MsaMaI/AAAAAAAAEac/iSQBeeXXAk49t0hjnlZE9dFc3xvYnJo2QCLcB/s1600/7.PNG" /></a><br /><br /><br /><br /><br /><br /><br />If the Secondary is green, resume Data Movement and after the status is Synchronised again perform a manual Failover so that the roles are swapped. Then perform all of the above on the <i>new Secondary </i>and you will be done.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-11kPZWY4ZKs/WM7B1MsaMaI/AAAAAAAAEac/iSQBeeXXAk49t0hjnlZE9dFc3xvYnJo2QCLcB/s1600/7.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a><a href="https://2.bp.blogspot.com/-XwGrJOM7kdo/WM7B1I9OAeI/AAAAAAAAEag/GlU_zqSw_wE2jYqWDICk_Art55uuisLMgCLcB/s1600/8.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="https://2.bp.blogspot.com/-XwGrJOM7kdo/WM7B1I9OAeI/AAAAAAAAEag/GlU_zqSw_wE2jYqWDICk_Art55uuisLMgCLcB/s1600/8.PNG" /></a></div><br /><br /><br /><br />Eventually, don't forget to re-enable any configuration you disabled before performing this!</div>