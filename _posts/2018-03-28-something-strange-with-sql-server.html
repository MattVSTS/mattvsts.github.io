---
layout: post
title: Something strange with SQL Server AlwaysOn Automatic Seeding and TFS
date: '2018-03-28T09:44:00.000+01:00'
author: Matteo Emili
tags: 
modified_time: '2018-03-28T09:44:03.277+01:00'
thumbnail: https://2.bp.blogspot.com/-ZFahYwfAO4w/WrtP_tep2KI/AAAAAAAAE3k/wMyGAqmZMeY37cZW0JLrDJ0x4gyxGyo8gCLcBGAs/s72-c/sql0.PNG
blogger_id: tag:blogger.com,1999:blog-9050180307874313601.post-8846951773498748085
blogger_orig_url: https://mattvsts.blogspot.com/2018/03/something-strange-with-sql-server.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">I ran into this strange issue the other day in my homelab, and it is worth sharing it: I was trying to setup a highly available Team Foundation Server data tier with AlwaysOn Automatic Seeding instead of the usual backup and restore process, but the TFS_Configuration database (for some reason) was not collaborating.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><i>Automatic seeding of availability database 'Tfs_Configuration' in availability group 'TFSAG' failed with an unrecoverable error. Correct the problem, then issue an ALTER AVAILABILITY GROUP command to set SEEDING_MODE = AUTOMATIC on the replica to restart seeding.</i><br /><i><br /></i>We are talking about a plain, empty instance, so... it was a bit of a needle in a haystack!<br /><br />Let's take a step back: SQL Server AlwaysOn Automatic Seeding is a new feature of SQL Server 2016 and above that manages to sync up a database in an Availability Group without leveraging backup and restore. This is a life saver in certain situations, so that you can avoid the computational load of a backup and of a restore that might take a long time.<br /><br />There are some constraints - above all, the instances making up the Availability Group must be *identical*. Yes, identical in everything, including paths used by SQL Server. It is a very cloud-first approach at the end of the day, where you have identical, commodity resources at your disposal and your actual target is to provide a friction-less experience to whom is going to consume the service you'll offer.<br /><br />So cool, right? Still, for some reason, my Configuration database didn't stream from Primary to Secondary replica. I checked the DMV, and I got an obscure 1200 failed_state error - Internal Error.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-ZFahYwfAO4w/WrtP_tep2KI/AAAAAAAAE3k/wMyGAqmZMeY37cZW0JLrDJ0x4gyxGyo8gCLcBGAs/s1600/sql0.PNG" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="567" data-original-width="815" height="277" src="https://2.bp.blogspot.com/-ZFahYwfAO4w/WrtP_tep2KI/AAAAAAAAE3k/wMyGAqmZMeY37cZW0JLrDJ0x4gyxGyo8gCLcBGAs/s400/sql0.PNG" width="400" /></a></div><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />The first thing I did (as the instances are really identical, they were provisioned the day before) was to check that I was on the latest CU, as there are <a href="https://support.microsoft.com/en-us/help/4040519/fix-automatic-seeding-in-availability-groups-randomly-causes-error-411">fixes available</a> for Automatic Seeding. Check.<br /><br />I had a look at the script used by the wizard to add the databases to the Availability Group, nothing too fancy to be fair. <a href="https://www.brentozar.com/archive/2016/06/availability-group-direct-seeding-fix-database-wont-sync/">Reading around</a> seems that there is still a chance that things might suddenly break, so I took another path.<br /><br />Yes, a Full Backup (taken with the TFS Administration Console nonetheless) was supposed to be enough to enable Automatic Seeding as the recovery chain is started. Would another Transaction Log backup hurt? I don't think so.<br /><br />After taking the <i>faulty</i>&nbsp;database off the Availability Group, I ran the speedy Transaction Log backup and added the database back in the Availability Group with the script. Guess what, it worked! And my new TFS instance is up-and-running.<br /><br />Of course this is totally transparent as usual for TFS, as the configuration wizard is smart enough to set the right connection string from the beginning. But you still need to make sure the Availability Group is correctly set, otherwise at the first failover you will be left with nothing.<br /><br /></div>