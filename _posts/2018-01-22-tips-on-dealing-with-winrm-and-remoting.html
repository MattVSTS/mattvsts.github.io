---
layout: post
title: Tips on dealing with WinRM and remoting using the Test Agent
date: '2018-01-22T17:29:00.001Z'
author: Matteo Emili
tags: 
modified_time: '2018-01-22T17:29:32.557Z'
thumbnail: https://lh3.googleusercontent.com/-trV7supafkQ/WmYfXU0TCHI/AAAAAAAAEyI/I4XS-DbSc4gvqT-Ri7HOVjC1diliJgiFQCHMYCw/s72-c/wlEmoticon-smile%255B2%255D?imgmax=800
blogger_id: tag:blogger.com,1999:blog-9050180307874313601.post-7930259595300689731
blogger_orig_url: https://mattvsts.blogspot.com/2018/01/tips-on-dealing-with-winrm-and-remoting.html
---

<p>Despite the push we’ve seen in the last few years, the Hosted Build Service might not be the right product for you for whatever reason.</p><p>Then, if you are in a situation where your agents aren’t running in the same domain as Team Foundation Server’s and you want to use the Test Agent then you really risk opening the Pandora’s box, courtesy of WinRM and PowerShell remoting.</p><p>And to be completely clear – I have nothing against them <img class="wlEmoticon wlEmoticon-smile" style="" alt="Smile" src="https://lh3.googleusercontent.com/-trV7supafkQ/WmYfXU0TCHI/AAAAAAAAEyI/I4XS-DbSc4gvqT-Ri7HOVjC1diliJgiFQCHMYCw/wlEmoticon-smile%255B2%255D?imgmax=800"> the only downside is that they need to be approached in the right way, otherwise the can-of-worms effect is just behind the corner.</p><p>First and foremost, remember that whenever you target a machine for Test Agent deployment you only need to consider the Build Agent-Test Agent relationship. All the errors you will get are going to be from the Test box, not the build box.</p><p>So when you need to configure WinRM, the Test box is the machine that is going to be accepting the connections. While it sounds straightforward, sometimes things happen and one is tempted to look at the Build box first: don’t.</p><p>Also, if you really want to use HTTP and WinRM, remember that this is the trickiest combination – so think twice before going down that route!</p><p>Then in terms of errors – you will likely face WinRM errors of all sorts. The most common is this:</p><p><a href="https://lh3.googleusercontent.com/-zhVwUNaP2t8/WmYfYbGi0PI/AAAAAAAAEyM/-c_GHmzxEyM_QeS8puuf6dpraHcg57ebACHMYCw/s1600-h/image%255B4%255D"><img width="504" height="152" title="image" style="display: inline; background-image: none;" alt="image" src="https://lh3.googleusercontent.com/-FiLTS1-_qIU/WmYfZrI0q1I/AAAAAAAAEyQ/duF0bPDJj-MF1Mkb0p27rmiwNZHn5pLAwCHMYCw/image_thumb%255B2%255D?imgmax=800" border="0"></a></p><p>If you are outside a domain then REMEMBER about <a href="https://mattvsts.blogspot.co.uk/2012/05/standard-environment-in-visual-studio.html">Shadow Accounts</a> – it is the only way to keep identity issues to a minimum. You’ll also need to set the TrustedHosts value to the machines <strong>pushing</strong> the agent.</p><p>Then this:</p><p><a href="https://lh3.googleusercontent.com/-p8riQ1-eO50/WmYfatY6dxI/AAAAAAAAEyU/s5k3Gi7rvm4vJY-eK_uyzV7igEcuoO4KgCHMYCw/s1600-h/image%255B8%255D"><img width="504" height="85" title="image" style="display: inline; background-image: none;" alt="image" src="https://lh3.googleusercontent.com/-WjAx-nuN9NE/WmYfboGKX4I/AAAAAAAAEyY/SOzAJW0CuisQPCB47NnllmfU9RO7hGBOwCHMYCw/image_thumb%255B4%255D?imgmax=800" border="0"></a></p><p>Remember that passwords need to match, and that mixing users at setup time isn’t really a good idea if you are going down the workgroup/non-trusted domain route. </p><p>Always triple check passwords, and I recommend to use the same account for both provisioning and execution, at least as a baseline. This will make sure you have a safety net incase things don’t pan out as expected.</p><p>Eventually there is this error, that really puzzles me:</p><p><a href="https://lh3.googleusercontent.com/-JH0gflOdw-w/WmYfcWBDRnI/AAAAAAAAEyc/arBo6omyJkAbyyxaxsXitMTdAmk7ymnEQCHMYCw/s1600-h/image%255B11%255D"><img width="244" height="25" title="image" style="margin: 0px; display: inline; background-image: none;" alt="image" src="https://lh3.googleusercontent.com/-Qhz5mZk-NZQ/WmYfdM-0e_I/AAAAAAAAEyg/v1PxXzLwk3k_i8AetVEp_s4Pt14hy4BNACHMYCw/image_thumb%255B5%255D?imgmax=800" border="0"></a></p><p>This is actually an aggregated exception:</p><p><a href="https://lh3.googleusercontent.com/-mJdw9imuYfM/WmYfd6VlajI/AAAAAAAAEyk/6bg1Fs7yqGMXoOAVCFQ51A43XQPCCMPrwCHMYCw/s1600-h/image%255B15%255D"><img width="504" height="66" title="image" style="display: inline; background-image: none;" alt="image" src="https://lh3.googleusercontent.com/-t7RR61hmCCI/WmYfe0r5eZI/AAAAAAAAEyo/LVkqbmPm7MI8AV-cMVpxmea1yzK_RY_YgCHMYCw/image_thumb%255B7%255D?imgmax=800" border="0"></a></p><p>Look at UAC and execution context for this – it always happens when you are not running stuff as Administrator when that’s supposed to be elevated. It always drives me mad.</p>